---
title: "Analyse data Nieuwkapelleplas"
author: "Florian"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_float:
      collapsed: FALSE
      smooth_scroll: FALSE
editor_options: 
  chunk_output_type: console
---
!! gebruik een project in R; met als submappen /data en /exports

```{r setup, results ='hide', eval = TRUE, echo = FALSE, message = FALSE, cache = FALSE, purl = FALSE, warning = FALSE}
library(knitr)
opts_chunk$set(
  echo = FALSE, 
  eval = TRUE,  
  cache = FALSE, 
  autodep = TRUE,
  dpi = 300,
  fig.width = 150 / 25.4,
  fig.height = 100 / 25.4,
  warning = TRUE,
  error = TRUE,
  message = TRUE
)

library(lubridate)
library(readxl) 
library(tidyverse)
library(ggplot2)
library(dplyr)
library(inbodb)
library(gridExtra)
library(ggpubr)
```

# import
```{r }
data <- read.csv2("./data/AC_NKP_ruwe_data_lang_2024-10-15.csv")
data$FieldSamplingDate <- as.Date(data$FieldSamplingDate)
data_ZP <- filter(data, data$FieldSampleID == "WVLDIK0133_ZP")
data_R <- filter(data, data$FieldSampleID == "WVLDIK0133_R")
```

# gemiddeldes, maximum, minimum per variabele per zone
```{r}
# voor zonnepaneelzone (_ZP)
data_ZP_stat <- data_ZP %>%
  group_by(AquaComponent) %>%
  summarise(
    gem = mean(ResultCalc),
    min = min(ResultCalc),
    max = max(ResultCalc),
    p10 = quantile(ResultCalc, probs = 0.1),
    p90 = quantile(ResultCalc, probs = 0.9)
  )

# voor randzone (_R)
data_R_stat <- data_R %>%
  group_by(AquaComponent) %>%
  summarise(
    gem = mean(ResultCalc),
    min = min(ResultCalc),
    max = max(ResultCalc),
    p10 = quantile(ResultCalc, probs = 0.1),
    p90 = quantile(ResultCalc, probs = 0.9)
  )
```

# figuren

per staalnamelocatie: alle gemeten variabelen met aanduiding van MKN richtwaarden (indien opgegeven) in figuur zetten
x = FieldSamplingDate
y = ResultCalc
label: als titel

```{r}
# vul hier MKN-norm in voor de te onderzoeken stof(fen)
## watertype Awe - Nieuwkappelleplas
MKN_O2conc = 6 # mg O2/L - 10p
MKN_02verz = 120 # % - maximum
MKN_TN = 1.3 # mg/L - zomerhalfjaargem
MKN_TP = 0.055 # mg/L - zomerhalfjaargem
MKN_doorzicht = 1.8 # m - zomerhalfjaargem
MKN_EC = 750 # µS/cm (20°C) - 90p
MKN_Cl = 140 # mg/L - gemiddelde
MKN_Sulfaat = 100 # mg/L - gemiddelde
MKN_temp = 25 # °C - maximum
titel_figuur = "Chloride-concentratie NKP (+ gemiddelde)"
naam_variabele = "Chloride (mg/L)"
naam_tijdsreeks = "Datum staalname"

# figuur met 2 trendlijnen (1 voor ZP, 1 voor R)
figuur <- data %>% 
    filter(AquaComponent == "Cl") %>% 
    ggplot(aes(x = FieldSamplingDate, y = ResultCalc, color = FieldSampleID)) + 
    geom_line() +
    geom_point() +
  geom_hline(yintercept = MKN_Cl, colour = "blue") +
  geom_hline(yintercept = data_ZP_stat$gem[data_ZP_stat$AquaComponent == "Cl"], color = "lightblue") +
  geom_hline(yintercept = data_R_stat$gem[data_R_stat$AquaComponent == "Cl"], color = "tomato2") +
  labs(title = titel_figuur)  + xlab(naam_tijdsreeks) + ylab(naam_variabele) +
    scale_x_date(date_breaks = "1 month", date_labels = "%b-%Y")
figuur

## pH - watertype Awe (met minimum en maximum)
MKN_pH_min = 6.5  # vul minimum pH in
MKN_pH_max = 8.5  # vul maximum pH in
titel_figuur = ""

## figuur 
figuur2a <- data %>% 
    filter(AquaComponent == "pH_veld") %>% 
    ggplot(aes(x = FieldSamplingDate, y = ResultCalc, color = FieldSampleID)) + 
    geom_line() +
    geom_point() +
  geom_hline(yintercept = MKN_pH_max, colour = "red") +
  geom_hline(yintercept = MKN_pH_min, colour = "red") +
  geom_hline(yintercept = data_ZP_stat$min[data_ZP_stat$AquaComponent == "pH_veld"], color = "lightblue") +
  geom_hline(yintercept = data_ZP_stat$max[data_ZP_stat$AquaComponent == "pH_veld"], color = "lightblue") +
  geom_hline(yintercept = data_R_stat$min[data_R_stat$AquaComponent == "pH_veld"], color = "tomato2") +
  geom_hline(yintercept = data_R_stat$max[data_R_stat$AquaComponent == "pH_veld"], color = "tomato2") +
  labs(title = titel_figuur)
figuur2a


```

Alle N-variabelen cumulatief in figuur zetten (Nitriet, nitraat, ammonium, OrgN = TN)
Aandeel van gemeten vennen voldoet aan MKN-normen (voor alle variabelen)

```{r}
# subset met nitraten (NO2, NO3, NH4)
nitraten <- subset(data, AquaComponent %in% c("NO2", "NO3", "NH4", "NH4_N", "NO2_N", "NO3_N"))
nutriënten <- subset(data, AquaComponent %in% c("NO2", "NO3", "NH4", "NH4_N", "NO2_N", "NO3_N", "TP"))
nutriënten_R <- subset(nutriënten, FieldSampleID == "WVLDIK0133_R")
nutriënten_ZP <- subset(nutriënten, FieldSampleID == "WVLDIK0133_ZP")
# cumulatieve som van nitraten per LabSampleID = TN / Totale stikstof
nitraten <- nitraten %>%
  group_by(FieldSamplingDate, FieldSampleID) %>%
  mutate(TN = sum(ResultCalc))
```



# democode functie 'maak_figuur' 
functie: maak figuur, laat deze zien en sla ze op
```{r}
# genereer plot en sla op
maak_figuur <- function(dataset, component, naam, title = NULL){
  figuur <- dataset %>%
    filter(AquaComponent %in% component) %>%  
    ggplot(aes(x = FieldSamplingDate, y = ResultCalc, color = label)) +
    scale_x_date(date_breaks = "1 month", date_labels = "%b-%Y") + # visualiseert data per maand in format maand-jaar
    geom_line() +
    geom_point() +
    labs(title = title)
  print(figuur)
  ggsave(plot = figuur,
         filename = paste0("./exports/NKP_", naam, ".jpg"), width = 9, height = 6)
}

# puur om plot te genereren
maak_plot <- function(dataset, component, title = NULL){
  figuur <- dataset %>%
    filter(AquaComponent %in% component) %>%  
    ggplot(aes(x = FieldSamplingDate, y = ResultCalc, color = label)) +
    scale_x_date(date_breaks = "1 month", date_labels = "%b-%Y") + # visualiseert data per maand in format maand-jaar
    geom_line() +
    geom_point() +
    labs(title = title)
  figuur
}
```

toepassing van deze functie
```{r}
plot_NO3 <- maak_figuur(nitraten, "NO3", "nitraat")
plot_pH_R <- maak_figuur(data_R, "pH_labo", "pH")
plot_pH_ZP <- maak_figuur(data_ZP, "pH_labo", "pH")

# meetreeks veldmetingen per plas
componenten_veld <- c("O2_veld", "O2verz", "sal_veld", "T_veld",
                                       "pH_tit", "pH_veld")
maak_figuur(data, componenten_veld, "veld", "Variabelen veldmeting Nieuwkappelleplas")
# geeft figuur met alle variabelen van veldmetingen per maand (! 2 metingen per maand voor O2verz !)
```


# democode: boxplots per variabele
afzonderlijke figuren per variabele
```{r warning=FALSE}
Componenten <- unique(data$AquaComponent) 

for (i in Componenten) { 
  data_figuur <- data %>% 
    filter(str_detect(AquaComponent, i)) 
  figuur <- ggplot(data_figuur, 
                   aes(x = FieldSampleID, y = ResultCalc)) + 
    geom_boxplot() +
    coord_flip() +
    labs(title = paste0(data_figuur$label))
  print(figuur)
  ggsave(figuur, 
         filename = paste0("./exports/plot_meetreeks_", "naam","_", i,".jpg"), 
         dpi = 200, width = 10, height = 10)
}
# geeft boxplots voor data per variabele, voor WVLDIK0133_ZP en WVLDIK0133_R
```

# chlorofyl, zwevende stof & doorzicht
```{r}
# hernoem chl_a van randzone naar chl_a_rand
data$AquaComponent[data$FieldSampleID == "WVLDIK0133_R" & data$AquaComponent == "chl_a"] <- "chl_a_rand"

# hernoem chl_a van zonnepaneelzone nar chl_a_zp
data$AquaComponent[data$FieldSampleID == "WVLDIK0133_ZP" & data$AquaComponent == "chl_a"] <- "chl_a_zp"

```

```{r}
# maak figuur
titel_figuur = "Parameters helderheid waterkolom"
plot_helderheid <- data %>% 
    filter(AquaComponent %in% c("chl_a_rand", "chl_a_zp", "SD_veld", "ZS_105")) %>% group_by(AquaComponent) %>%
    ggplot(aes(x = FieldSamplingDate, y = ResultCalc, color = AquaComponent)) + 
    geom_line() +
    geom_point() +
  labs(title = titel_figuur)  +
    scale_x_date(date_breaks = "1 month", date_labels = "%b-%Y") +
  geom_line()+
  scale_color_discrete(labels = c("chlorofyl_rand (µg/L)", "chlorofyl_zonnepaneel (µg/L)", "Secchi-diepte (m)", "zwevende stof (g/L)")) + labs(color = "Variabele", x = "Datum", y = "Meetwaarde (log10)")  + theme(legend.key.size = unit(2, "cm"))
plot_helderheid + scale_y_continuous(trans = "log10")

# legende binnen grafiek
## legend.position = c(0.15,0.7), 

# figuren zij aan zij
#maak_plot()
```

# nutriëntenlast
```{r}
# TP data
TP <- data %>%
  filter(AquaComponent == "TP") %>%
  select(FieldSampleID, FieldSamplingDate, ResultCalc, label) %>% rename("TP" = ResultCalc)
# TN = som van nitraten
TN <- data %>% filter(AquaComponent %in% c("NO2", "NO3", "NH4", "NH4_N", "NO2_N", "NO3_N")) %>%
  group_by(FieldSamplingDate, FieldSampleID) %>%
  summarise(TN = sum(ResultCalc))

Totalen_N_P <- left_join(TN, TP, by = c("FieldSamplingDate", "FieldSampleID"))


## converteer nutrienten van long naar wide dataformat voor merge met cumsum
nitraten <- nitraten %>%
  select(FieldSampleID, FieldSamplingDate, ResultCalc, label) %>%
  group_by(FieldSamplingDate, FieldSampleID) %>%
  mutate(TN = sum(ResultCalc))

# met dataset nutriënten (zie hoger)
Nutr_R <- maak_plot(nutriënten_R, nutriënten_R$AquaComponent, "Nutriënten_randzone")
Nutr_ZP <- maak_plot(nutriënten_ZP, nutriënten_ZP$AquaComponent, "Nutriënten_zonnepanelen")
ggarrange(Nutr_R, Nutr_ZP, nrow = 1, common.legend = TRUE, legend = "right") + geom_line(data = cumsum, aes(x = FieldSamplingDate, y = TN))

#

```
